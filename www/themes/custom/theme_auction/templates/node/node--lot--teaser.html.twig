{#
/**
 * @file
 * Teaser template voor lot met live soft-close countdown.
 *
 * Verwacht in preprocess:
 * - lot_end_ts (UNIX timestamp, effectieve eindtijd via auction_core.soft_close)
 * - server_now_ts (UNIX timestamp; voor drift-correctie)
 * - bidding_form (optioneel: AuctionSubmit form in teaser view_mode)
 *
 * Vereiste libraries:
 * - theme_auction/auction.countdown (JS voor timers + batch polling)
 *
 * Let op selectors (compat met jouw AJAX in AuctionSubmit.php):
 * - #c-lot-counter-{{ node.id }} .highest_bid   (AJAX update hoogste bod)
 * - #auction-submit-{{ node.id }} .result_message (AJAX feedback)
 */
#}

{{ attach_library('classy/node') }}
{{ attach_library('theme_auction/auction.countdown') }}

{# Handige classes (pas aan naar je eigen BEM als je wilt) #}
{% set classes = [
  'node',
  'node--type-lot',
  'node--view-mode-teaser',
  logged_in ? 'is-logged-in',
] %}

<article{{attributes.addClass(classes)}}>
	<header class="c-lot-teaser__header">
		<h3 class="c-lot-title">
			<a href="{{ url }}">{{ label }}</a>
		</h3>

		{# Optioneel: lotnummer tonen als veld #}
		{% if content.field_lot_nr is defined %}
			<div class="c-lot-number">
				{{ 'Lot'|t }}
				{{ content.field_lot_nr }}
			</div>
		{% endif %}
	</header>

	{# Afbeelding / media (optioneel) #}
	{% if content.field_image is defined %}
		<div class="c-lot-media">
			{{ content.field_image }}
		</div>
	{% endif %}

	{# Korte beschrijving (optioneel) #}
	{% if content.body is defined %}
		<div class="c-lot-summary">
			{{ content.body }}
		</div>
	{% endif %}

	{# Einde-label met live aanpasbare tijd (js-endtime) #}
	{% if lot_end_ts is defined and server_now_ts is defined %}
		<div class="c-lot-teaser__enddate">
			<span class="end-label">
				{{ 'Bieden op dit lot eindigt op'|t }}
				{{ lot_end_ts|format_date('custom', 'd/m') }}
				{{ 'om'|t }}
				<span class="js-endtime">{{ lot_end_ts|format_date('custom', 'H:i:s') }}</span>
			</span>
		</div>

		{# Countdown container met data-attributen #}
		<div class="c-lot-counter c-lot-timer" id="c-lot-counter-{{ node.id }}" data-lot-id="{{ node.id }}" data-end-ts="{{ lot_end_ts }}" data-server-now="{{ server_now_ts }}">
			<span class="js-countdown" aria-live="polite">
				{{ lot_end_ts|format_date('custom','H:i:s') }}
			</span>

			{# Huidige/hoogste bod (AJAX update schrijft hier naar .highest_bid) #}
			<div class="c-lot-highest">
				<span class="label">{{ 'Huidig bod:'|t }}</span>
				<span
					class="highest_bid">
					{# Toon voorkeur: variabele highest_offer, anders veldwaarde #}
					{% if highest_offer is defined and highest_offer %}
						{{ highest_offer }}
					{% elseif content.field_highest_bid is defined %}
						{{ content.field_highest_bid }}
					{% else %}
						—
					{% endif %}
				</span>
			</div>
		</div>
	{% else %}
		{# Fallback als preprocess nog geen lot_end_ts meegaf #}
		<div class="c-lot-counter c-lot-timer">
			<span class="countdown-finished">{{ 'Tijd onbekend'|t }}</span>
		</div>
	{% endif %}

	{# Biedformulier (AJAX). We plaatsen een wrapper met id waar jouw Ajax naar target. #}
	<div class="c-lot-bod-wrapper c-lot-bid" id="auction-submit-{{ node.id }}">
		{% if bidding_form is defined and bidding_form %}
			{{ bidding_form }}
		{% else %}
			{# Optioneel: link naar biedpagina/aanmelden #}
			{% if bidding_link is defined and bidding_link %}
				<div class="c-lot-bid-cta">
					{{ bidding_link }}
				</div>
			{% endif %}
		{% endif %}
	</div>

	{# Extra velden die je wél in teaser wil tonen #}
	<div class="c-lot-meta">
		{% if content.field_minimum_offer is defined %}
			<div class="c-lot-min-offer">
				<span class="label">{{ 'Openingsbod:'|t }}</span>
				{{ content.field_minimum_offer }}
			</div>
		{% endif %}

		{# voorbeeld: aankoper / categorieën, pas aan naar eigen velden #}
		{% if content.field_category is defined %}
			<div class="c-lot-category">
				{{ content.field_category }}
			</div>
		{% endif %}
	</div>

</article>
